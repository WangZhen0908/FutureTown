package com.vvage.futuretown.network;

import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.net.URI;

import org.apache.http.HttpHost;
import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.conn.params.ConnRoutePNames;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.params.BasicHttpParams;
import org.apache.http.params.HttpConnectionParams;
import org.apache.http.params.HttpParams;
import org.apache.http.util.EntityUtils;

import com.vvage.futuretown.model.BaseJsonReader;
import com.vvage.futuretown.model.JsonReader;

import android.content.ContentResolver;
import android.content.Context;
import android.database.Cursor;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.net.Uri;
import android.util.Log;

public class Http {
	static String tag = "HttpConnector_f";

	public static final int GET = 0;
	public static final int POST = 1;

	/**
	 * 接入点类型
	 */
	public enum APNType {
		CMWAP, CMNET, Unknow, CTWAP, CTNET, _3GNET, _3GWAP, UNIWAP;
	}

	static Uri PREFERRED_APN_URI = Uri
			.parse("content://telephony/carriers/preferapn");
	static String proxyAddress = "";// "10.0.0.200";
	static String proxyProt = "";// "80";

	public static final String CMPROXY = "10.0.0.172";
	public static final String CTPROXY = "10.0.0.200";
	public static final String PROT = "80";

	private long execTime;
	private long currentTime;

	private static Http mInstance;

	private Http() {
	}

	public static Http getInstance() {
		if (mInstance == null) {
			mInstance = new Http();
		}
		return mInstance;
	}
	
	public void uploadFile(){
		
	}

	public void HttpRequest(Context context, JsonReader jr) throws ErrorMsg {
		DataInputStream dis = null;
		String data;
		try {
			data = getData(context, jr.getUrl(), jr.HttpRequestType(), jr.toString());
//			dis = new DataInputStream(new ByteArrayInputStream(data.getBytes()));
			currentTime = System.currentTimeMillis();
			jr.read(data);
			currentTime -= System.currentTimeMillis();
			if (currentTime > 2000) {
				Log.w("checkTime", "data=" + currentTime);
			} else {
				Log.d("checkTime", "data=" + currentTime);
			}

		} catch (Exception e) {
			// TODO: handle exception
			e.printStackTrace();
			throw new ErrorMsg("网络错误，请稍候重试...");
		}
	}

	private String getData(Context context, String url, int requestType, String post)throws Exception{
		String str=null;
		DefaultHttpClient http = null;
		try {
			http = creatHttp(context, requestType);
			URI uri = new URI(url);
			// 0 is GET
			if(requestType == GET){
				HttpGet get = new HttpGet(uri);
				execTime = System.currentTimeMillis();
				HttpResponse rsp = http.execute(get);
				execTime -=System.currentTimeMillis();
				if (execTime > 2000) {
					Log.w("checkTime", "http=" + execTime);
				} else {
					Log.d("checkTime", "http=" + execTime);
				}
				if (rsp.getStatusLine().getStatusCode() == 200) {
					str = EntityUtils.toString(rsp.getEntity());
//					return str.trim();
				} else {
					return "Error Response: " + rsp.getStatusLine().toString();
				}
			}else if(requestType == POST){
				HttpPost req = new HttpPost(uri);
				StringEntity entity = new StringEntity(post, "utf-8");
				req.setEntity(entity);
				execTime = System.currentTimeMillis();
				HttpResponse rsp = http.execute(req);
				execTime -=System.currentTimeMillis();
				if (execTime > 2000) {
					Log.w("checkTime", "http=" + execTime);
				} else {
					Log.d("checkTime", "http=" + execTime);
				}
				if (rsp.getStatusLine().getStatusCode() == 200) {
					str = EntityUtils.toString(rsp.getEntity());
//					return str.trim();
				} else {
					return "Error Response: " + rsp.getStatusLine().toString();
				}
			}
			
			
		} finally {
			if (http != null) {
				http.getConnectionManager().shutdown();
			}
		}
		return str.trim();
	}

	private DefaultHttpClient creatHttp(Context context, int requestType) {
		DefaultHttpClient client=null;
		if (requestType == POST) {
			HttpHost proxy = null;
			APNType apnType = getCurrentAPNType(context);
			if (APNType.CTWAP.equals(apnType)) {// 电信
				proxy = new HttpHost(CTPROXY, Integer.parseInt(PROT));
			} else if (APNType.CMWAP.equals(apnType)) {// 移动
				proxy = new HttpHost(CMPROXY, Integer.parseInt(PROT));
			} else if (APNType._3GWAP.equals(apnType)) {// 联通
				proxy = new HttpHost(CMPROXY, Integer.parseInt(PROT));
			}
			HttpParams p = new BasicHttpParams();
			int timeoutConnection = 10*1000;
			HttpConnectionParams.setConnectionTimeout(p, timeoutConnection);
			int timeoutSocket = 10 * 1000;
			HttpConnectionParams.setSoTimeout(p, timeoutSocket);
			client =  new DefaultHttpClient(p);
			// 没有wifi就不设置代理
			if (!testWifi(context)) {
				if (proxy != null) {
					client.getParams().setParameter(ConnRoutePNames.DEFAULT_PROXY, proxy);
				}
			}
		} else if (requestType == GET) {
			client = new DefaultHttpClient();
		}
		
		return client;
	}

	private APNType getCurrentAPNType(Context context) {
		try {
			ContentResolver cr = context.getContentResolver();
			Cursor c = cr.query(PREFERRED_APN_URI, new String[] { "_id",
					"name", "apn", "proxy", "port" }, null, null, null);
			c.moveToFirst();
			if (c.isAfterLast()) {
				return APNType.Unknow;
			}
			String id = c.getString(0);
			String name = c.getString(1);
			String apn = c.getString(2);
			String proxy = c.getString(3);
			String port = c.getString(4);

			if (proxy != null && !proxy.equals("")) {
				proxyAddress = proxy;
			}
			if (port != null && !port.equals("")) {
				proxyProt = port;
			}

			c.close();

			if (// "1".equals(id) || //三星电信1为ctwap,2为ctnet
			(("CTWAP".equals(apn.toUpperCase()) || "CTWAP".equals(name
					.toUpperCase())) && !isEmpty(proxy) && !isEmpty(port)))
				return APNType.CTWAP;
			else if (// "2".equals(id) ||
			(("CTNET".equals(apn.toUpperCase()) || "CTNET".equals(name
					.toUpperCase())) && isEmpty(proxy) && isEmpty(port)))
				return APNType.CTNET;
			else if (("CMWAP".equals(apn.toUpperCase()) || "CMWAP".equals(name
					.toUpperCase())) && !isEmpty(proxy) && !isEmpty(port))
				return APNType.CMWAP;
			else if (("CMNET".equals(apn.toUpperCase()) || "CMNET".equals(name
					.toUpperCase())) && isEmpty(proxy) && isEmpty(port))
				return APNType.CMNET;
			else if (("3GWAP".equals(apn.toUpperCase()) || "3GWAP".equals(name
					.toUpperCase())) && !isEmpty(proxy) && !isEmpty(port))
				return APNType._3GWAP;
			else if (("3GNET".equals(apn.toUpperCase()) || "3GNET".equals(name
					.toUpperCase())) && isEmpty(proxy) && isEmpty(port))
				return APNType._3GNET;
			else
				return APNType.Unknow;

		} catch (Exception e) {
			// TODO: handle exception
			Log.e(tag, "getCurrentUsedAPNTypeException");
			return APNType.Unknow;
		}
	}

	public class ErrorMsg extends Throwable {
		private String errorStr;

		public ErrorMsg(String msg) {
			errorStr = msg;
		}

		public String toString() {
			return errorStr;
		}
	}

	public static boolean isEmpty(String str) {
		return str == null || "".equals(str);
	}
	
	public static boolean testWifi(Context ctx) {
		ConnectivityManager mConnectivity = (ConnectivityManager) ctx.getSystemService(Context.CONNECTIVITY_SERVICE);
		NetworkInfo info = mConnectivity.getActiveNetworkInfo();
		if (info == null || !mConnectivity.getBackgroundDataSetting()) {
			Log.d(tag, "!mConnectivity.getBackgroundDataSetting()" + mConnectivity.getBackgroundDataSetting());
			return false;
		}
		int netType = info.getType();
		int netSubType = info.getSubtype();
		Log.d(tag, "netType:" + netType + " netSubType:" + netSubType);
		if (ConnectivityManager.TYPE_WIFI == netType) {
			Log.d(tag, "TYPE_WIFI");
			return info.isConnectedOrConnecting();
		}
		return false;
	}

}
